# Handover Document - January 7, 2026

## Overview
This document summarizes work completed on January 7, 2026, including GHL API research, form field implementations, and pending tasks for future sessions.

---

## What We Accomplished Yesterday

### 1. GHL Duplicate Address Check Research
**Goal:** Implement duplicate address checking in GHL custom objects before creating new property records.

**Key Finding:** ‚ö†Ô∏è **GHL API does NOT support searching custom objects by field values**, even if fields are marked as searchable or unique in the UI.

**What We Tried:**
- Multiple API endpoint attempts (POST `/objects/search`, GET with query parameters, various URL structures)
- All attempts returned 404 errors
- Tested with field marked as "searchable" and "unique" in GHL UI
- Confirmed that UI search works, but API search does not exist

**Current Status:**
- Make.com scenario created with fallback error handling
- **API Route:** `src/app/api/ghl/check-address/route.ts`
- **Webhook URL (in code):** `https://hook.eu1.make.com/u63eqhdemilc7wsaw3ub4mjxwbc6da75`
- **Note:** There may be a discrepancy - handover doc mentions different URL (`fcjabbpzv88sya6twvn2pa8whalj2vei`). Code URL takes precedence.
- Currently returns: `{exists: false, error: "GHL search endpoint not available"}`
- Form proceeds without duplicate check (relying on GHL's unique field constraint)
- **Error Handling:** "Fail open" approach - if check fails, allows folder creation to proceed

**Documentation Created:**
- `GHL-DUPLICATE-ADDRESS-CHECK-HANDOVER.md` - Initial problem statement and attempts
- `GHL-SEARCH-ATTEMPTS-AND-FINDINGS.md` - Detailed log of all API attempts and findings

**Next Steps (Future):**
- Contact GHL support to confirm if search API exists
- Consider alternative approaches (GHL workflows, separate database index)
- Or accept limitation and handle duplicates reactively

---

### 2. Lot Number Field Implementation
**Location:** Step 2 (Decision Tree) - `src/components/steps/Step1DecisionTree.tsx`

**Requirements:**
- Appears only for H&L properties (New + Individual, not Established)
- Mandatory field with "Not Applicable" option
- If lot number entered: prepends "Lot X, " to address in Step 1
- If "Not Applicable" checked: lot number field disabled, nothing added to address
- Mutual exclusivity: cannot have both lot number AND "Not Applicable" selected

**Implementation Details:**
- Added `lotNumber?: string` and `lotNumberNotApplicable?: boolean` to `AddressData` type
- Input validation: numeric or "TBC" only (case-insensitive)
- Address formatting: builds from individual components to preserve street number/name
- Cascading clear: resets when property type changes

**Status:** ‚úÖ Complete and deployed to Vercel

---

### 3. Unit Number Field Implementation
**Location:** Step 2 (Decision Tree) - `src/components/steps/Step1DecisionTree.tsx`

**Requirements:**
- Appears for all property types except Projects (H&L, Established)
  - **Note:** Projects have their own lot system in the "Project Lots" section, so unit numbers are not needed/applicable
- Two-part question:
  1. "Does this property have unit numbers?" (Yes/No - mandatory)
  2. "Which unit(s) are we buying?" (appears if Yes selected)
- Supports single unit ("1"), range ("1-8"), or comma-separated list ("A,B,C")
- Auto-selects "Yes" if Dual Occupancy = "Yes" (see Dual Occupancy Auto-Select Logic below)
- Prepends to address: "Unit 1, " or "Units 1-8, " or "Units A,B,C, "
- Initial state: `undefined` (unselected), not `false` (prevents auto-population)

**Implementation Details:**
- Added `hasUnitNumbers?: boolean` and `unitNumber?: string` to `AddressData` type
- Replaced old `totalUnitsAtAddress` field
- Address formatting: builds from individual components to preserve street number/name
- Validation: requires unit number if "Yes" selected (including Dual Occupancy auto-select)
- Cascading clear: resets when property type changes (see Cascading Clear Logic below)

**Status:** ‚úÖ Complete and deployed to Vercel

---

### 4. Address Formatting Fix
**Problem:** When adding Lot/Unit numbers, street number and street name were disappearing from the address.

**Solution:** Rewrote address formatting logic to build `propertyAddress` from individual components (`streetNumber`, `streetName`, `suburbName`, `state`, `postCode`) rather than using regex to strip prefixes. This ensures all address parts are preserved.

**Status:** ‚úÖ Fixed

---

### 5. Validation System Fix
**Problem:** Validation errors were not being caught and displayed correctly.

**Solution:** Replaced all `setValidationError` calls with `setValidationErrorWithRef` wrapper function to ensure synchronous ref updates that `handleNext` can properly catch.

**Status:** ‚úÖ Fixed

---

### 6. "Clear Decision Tree Data" Button Fix
**Problem:** Clicking "Clear Decision Tree Data" did not clear lot/unit number fields, and address retained old lot/unit prefixes.

**Solution:** Updated the button's onClick handler to:
- Clear `lotNumber`, `lotNumberNotApplicable`, `hasUnitNumbers`, `unitNumber` from both local state and global form store
- Clear `numberOfLots` and `lots` (for Projects)
- Rebuild `propertyAddress` from individual components (removing lot/unit prefixes)

**Status:** ‚úÖ Fixed

---

### 7. Cascading Clear Logic (Property Type Changes)
**Problem:** When changing `propertyType` or `lotType`, dependent fields (lot/unit numbers) retained old values, leading to incorrect addresses.

**Solution:** Implemented `useEffect` hooks that automatically clear dependent fields when:
- Property type changes to `null` (clears everything)
- Property type changes to "Established" (clears lot number, clears unit numbers unless Dual Occupancy = "Yes")
- Property type changes to "New" + "Multiple" (Project - clears lot/unit fields, handled by Project Lots section)

**Key Behavior:**
- `clearDependentAddressFields()` helper function rebuilds address from individual components
- Prevents stale lot/unit data from appearing in wrong property types
- Maintains address integrity when switching between property types

**Status:** ‚úÖ Fixed

---

### 8. Initial State Fixes
**Bugs Fixed:**
- **"Not Applicable" defaulting to checked:** Changed initial state from `true` to `false`
- **Unit numbers defaulting to "No":** Changed initial state from `false` to `undefined` (unselected)
- **Lot number visibility for Established:** Fixed conditional to only show for H&L (New + Individual), not Established

**Status:** ‚úÖ Fixed

---

### 9. Dual Occupancy Auto-Select Logic
**Implementation:** 
- When `dualOccupancy === 'Yes'`, automatically sets `hasUnitNumbers = true` (unit numbers required for dual occupancy)
- When `dualOccupancy` changes away from "Yes", resets `hasUnitNumbers` to `undefined` if no unit number was entered (meaning it was auto-set)
- Prevents user from proceeding without unit number when Dual Occupancy is selected
- Validation enforces unit number requirement when Dual Occupancy = "Yes"

**Status:** ‚úÖ Complete

---

### 10. Stash Zoning Visual Indicator
**Location:** Step 1 (Address & Risk) - `src/components/steps/Step0AddressAndRisk.tsx`

**Implementation:** Added warning message when Stash is checked but doesn't return zoning information:
```tsx
‚ö†Ô∏è Stash did not return zoning information for this address. Please enter zoning manually if known.
```

**Status:** ‚úÖ Complete

---

## Documentation Files Created

These files serve as a to-do list and reference for future work:

1. **`GHL-DUPLICATE-ADDRESS-CHECK-HANDOVER.md`**
   - Initial problem statement
   - GHL API structure and working/non-working endpoints
   - Make.com scenario configuration
   - Next steps and options

2. **`GHL-SEARCH-ATTEMPTS-AND-FINDINGS.md`**
   - Detailed log of all API attempts
   - Correct endpoint configuration (for future retry)
   - Key findings about GHL API limitations
   - Recommendations for alternative approaches

3. **`MARKET-PERFORMANCE-FIXES-NEEDED.md`**
   - Issue 1: N/A not allowed in input fields
   - Issue 2: Market Performance Additional Dialogue missing
   - Issue 3: Unclear error message about saving data
   - Issue 4: Data not refreshing from Google Sheet (complex - needs discussion)

4. **`STASH-ZONING-ISSUE.md`**
   - Problem: Zoning field not populated from Stash
   - Expected behavior
   - Action needed (partially addressed with visual indicator)

---

## Pending Tasks (To-Do List)

### üî¥ HIGH PRIORITY

1. **Folder Creation Timing** ‚è∏Ô∏è ON HOLD
   - **Current:** Folder created when "Continue with Packaging" is clicked (Step 1)
   - **Issue:** Lot number is not yet confirmed at this point, so folder name doesn't include lot number
   - **Proposed:** Move folder creation to end of packaging process (after Step 5 submission)
   - **Benefit:** Folder name can include complete address with lot number
   - **Status:** Discussion needed - user mentioned "we can discuss that tomorrow"
   - **Related:** Folder creation API currently disabled/not working (intentionally)

2. **Post-Submission Screen/Behavior**
   - **Current:** After form submission, shows alert: "Form data exported to [filename]"
   - **Need to Address:**
     - What screen is shown after submission?
     - Should we show a confirmation page with links?
     - Should we provide links to view property in GHL?
     - Should we show submission status?
   - **Reference:** See `POST-SUBMISSION-ENHANCEMENTS.md` for ideas
   - **Status:** Needs discussion and implementation

3. **Field Mapping: Emails vs GHL Custom Object**
   - **Need to Confirm:**
     - Which fields go to email template?
     - Which fields go to GHL custom object?
     - Which fields go to both?
   - **Reference:** See `FIELD-MAPPING-MATRIX.md` for current mapping
   - **New Fields to Add:**
     - `lotNumber` - needs to be added to GHL custom object and email template
     - `unitNumber` - needs to be added to GHL custom object and email template
   - **Status:** Needs confirmation and implementation

4. **Add New Fields to Integrations**
   - After confirming field mapping, need to:
     - Add `lotNumber` to GHL custom object (if field doesn't exist)
     - Add `unitNumber` to GHL custom object (if field doesn't exist)
     - Update Make.com scenarios to include these fields
     - Update email template to include these fields
     - Update Google Sheets Deal Sheet integration (if applicable)
   - **Status:** Waiting on field mapping confirmation

### üü° MEDIUM PRIORITY

5. **Market Performance Data Refresh**
   - **Issue:** When navigating back to Market Performance step, it preserves user-entered data instead of always fetching fresh data from Google Sheet
   - **Impact:** If user edits values in Google Sheet manually, form doesn't pick them up
   - **Proposed Solution:** Always fetch from Google Sheet when step is visited, with conflict resolution
   - **Reference:** See `MARKET-PERFORMANCE-FIXES-NEEDED.md` Issue 4
   - **Status:** Needs implementation

6. **Market Performance Additional Dialogue**
   - **Issue:** Component exists but might be hidden - need to check visibility logic
   - **Status:** Needs investigation

7. **Market Performance N/A Input**
   - **Issue:** Input fields do not allow typing "N/A"
   - **Status:** Needs fix

### üü¢ LOW PRIORITY

8. **Google Sheets Force Copy Link**
   - **Requirement:** Cashflow spreadsheet needs "force copy" link so users can edit dropdowns without editing master file
   - **Approach:** Replace `/edit` with `/copy` in Google Sheets URL
   - **Status:** Documented in todos, needs implementation
   - **Reference:** User confirmed approach - each person gets their own copy in their Drive

---

## Technical Details

### New Form Fields Added

**Type Definitions:** `src/types/form.ts`
```typescript
export interface AddressData {
  lotNumber?: string; // Lot number for H&L (numeric or "TBC")
  lotNumberNotApplicable?: boolean; // Flag for "Not Applicable"
  unitNumber?: string; // Unit number(s) - single, range, or list
  hasUnitNumbers?: boolean; // Does property have unit numbers? (Yes/No)
  // ... other fields
}
```

**Component:** `src/components/steps/Step1DecisionTree.tsx`
- Lot Number section: Conditional rendering for H&L only (`isHAndL && ...`)
- Unit Number section: Conditional rendering for non-Project types (`hasPropertyType && !isProject && ...`)
- Address rebuilding logic: `clearDependentAddressFields()` helper function
- Cascading clear logic: Multiple `useEffect` hooks for property type/lot type changes
- Dual Occupancy auto-select: `useEffect` hook for `decisionTree.dualOccupancy`
- State synchronization: `useEffect` hooks to sync local state with `address` data

**Validation:** `src/components/MultiStepForm.tsx`
- Lot Number validation: 
  - For H&L properties: requires either lot number (numeric or "TBC") OR "Not Applicable" checkbox
  - Validates input is numeric or "TBC" (case-insensitive)
- Unit Number validation:
  - Requires "Yes" or "No" for `hasUnitNumbers` (for non-Project types)
  - If `hasUnitNumbers === true`: requires `unitNumber` to be non-empty
  - Specifically validates for Dual Occupancy: if `dualOccupancy === 'Yes'`, ensures `hasUnitNumbers === true` and `unitNumber` is not empty
- All validation errors use `setValidationErrorWithRef` to ensure proper error display

### Address Formatting Logic

**Format Examples:**
- "Lot 17, 123 Main Street, Suburb State 1234"
- "Unit 1, 123 Main Street, Suburb State 1234"
- "Lot 17, Units 1-8, 123 Main Street, Suburb State 1234"
- "Units A,B,C, 123 Main Street, Suburb State 1234"

**Implementation:** Address is built from components in this order:
1. Lot number (if exists)
2. Unit number(s) (if exists)
3. Street number
4. Street name
5. Suburb name
6. State
7. Post code

---

## GHL API Information

### Working Endpoints
- `GET /objects/{objectId}/records/{recordId}` - Get record by ID ‚úÖ
- `PUT /objects/{objectId}/records/{recordId}` - Update record by ID ‚úÖ

### Non-Working Endpoints
- `POST /objects/search` - Search by field value ‚ùå (404)
- `GET /objects/{objectId}/records` - List all records ‚ùå (404)
- `GET /objects/{objectId}/records?filter[...]` - Filter by field ‚ùå (404)

### GHL Configuration
- **Base URL:** `https://services.leadconnectorhq.com`
- **Custom Object ID:** `692d04e3662599ed0c29edfa`
- **Location ID:** `UJWYn4mrgGodB7KZUcHt`
- **Bearer Token:** `pit-d375efb5-f445-458d-af06-3cbbb4b331dd`
- **API Version:** `2021-07-28`

---

## Make.com Scenarios

### "Check Address Duplicate"
- **Webhook URL:** `https://hook.eu1.make.com/fcjabbpzv88sya6twvn2pa8whalj2vei`
- **Status:** Configured with error handling, but cannot actually search GHL
- **Current Response:** Returns error message indicating search is unavailable

### Other Scenarios (Reference)
- **"GHL Property Review Submitted"** - Main workflow triggered on property creation
- **"Property Review Approval Webhook"** - Updates property on approval
- See `docs/EXISTING-GHL-INFRASTRUCTURE.md` for full list

---

## Code Locations

### Lot Number & Unit Number Fields
- **Component:** `src/components/steps/Step1DecisionTree.tsx`
- **Type Definitions:** `src/types/form.ts` (AddressData interface)
- **Validation:** `src/components/MultiStepForm.tsx` (validateStep function)

### Address Formatting
- **Component:** `src/components/steps/Step1DecisionTree.tsx` (address rebuilding logic)
- **Normalization Utility:** `src/lib/addressNormalizer.ts` (exists but not currently used)

### Stash Integration
- **Component:** `src/components/steps/Step0AddressAndRisk.tsx`
- **Zoning Display:** Added visual indicator for missing zoning data

### GHL Duplicate Address Check
- **API Route:** `src/app/api/ghl/check-address/route.ts`
- **Integration:** Called from `Step0AddressAndRisk.tsx` when "Check Stash" or "Continue with Packaging" is clicked
- **Make.com Webhook:** `https://hook.eu1.make.com/u63eqhdemilc7wsaw3ub4mjxwbc6da75`
- **Behavior:** "Fail open" - if check fails, proceeds with folder creation
- **Current Response:** Always returns `{exists: false}` due to GHL API limitation

### Folder Creation
- **API Route:** `src/app/api/create-property-folder/route.ts`
- **Trigger:** `src/components/steps/Step0AddressAndRisk.tsx` (line ~927)
- **Status:** Currently disabled/not working (intentionally - pending move to end of process)

---

## Next Session Priorities

1. **Confirm Field Mapping** - Which fields go to emails vs GHL vs both
2. **Add New Fields to Integrations** - Add `lotNumber` and `unitNumber` to GHL, email template, Make.com scenarios
3. **Address Folder Creation Timing** - Move to end of packaging process
4. **Design Post-Submission Screen** - What happens after form submission?

---

## Questions for User

1. **Folder Creation:** Should we move folder creation to end of packaging process? (User mentioned discussing tomorrow)
2. **Post-Submission:** What should the screen show after form submission? Links to GHL? Confirmation page?
3. **Field Mapping:** Confirm which fields (`lotNumber`, `unitNumber`) should go to:
   - Email template?
   - GHL custom object?
   - Both?
4. **Market Performance:** Should Market Performance step always refresh from Google Sheet, or preserve user-entered data?

---

## Notes for New Chat Session

- **Deployment:** All changes are deployed to Vercel (not local)
- **Git:** Changes are committed and pushed
- **Validation:** Fixed validation system to use `setValidationErrorWithRef` for all validation errors
- **Address Formatting:** Fixed to preserve all address components when adding lot/unit numbers (rebuilds from individual components)
- **Cascading Clears:** Implemented to reset dependent fields when property type/lot type changes
- **Initial States:** Fixed to prevent auto-population (lotNumberNotApplicable: false, hasUnitNumbers: undefined)
- **Clear Button:** "Clear Decision Tree Data" now properly clears lot/unit fields and rebuilds address
- **Dual Occupancy:** Auto-selects unit numbers and enforces validation
- **Projects:** Note that Projects have their own lot system, so unit numbers are for H&L/Established only
- **GHL API Limitation:** Documented - cannot search custom objects by field values via API

---

## Related Documentation Files

- `GHL-DUPLICATE-ADDRESS-CHECK-HANDOVER.md` - Initial GHL search problem
- `GHL-SEARCH-ATTEMPTS-AND-FINDINGS.md` - Detailed API attempts
- `MARKET-PERFORMANCE-FIXES-NEEDED.md` - Market Performance issues
- `STASH-ZONING-ISSUE.md` - Stash zoning problem (partially addressed)
- `FIELD-MAPPING-MATRIX.md` - Field mapping reference
- `POST-SUBMISSION-ENHANCEMENTS.md` - Post-submission ideas
- `docs/EXISTING-GHL-INFRASTRUCTURE.md` - GHL infrastructure reference

---

**Last Updated:** January 7, 2026
**Next Session Focus:** Field mapping confirmation, integration updates, folder creation timing, post-submission screen

